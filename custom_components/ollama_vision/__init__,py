"""The Ollama Vision integration."""
import logging
import voluptuous as vol
import aiohttp

from homeassistant.config_entries import ConfigEntry
from homeassistant.core import HomeAssistant, ServiceCall, callback
from homeassistant.helpers.typing import ConfigType
from homeassistant.helpers import config_validation as cv
from homeassistant.exceptions import HomeAssistantError
from homeassistant.const import CONF_NAME, Platform
import homeassistant.helpers.entity_registry as er

from .const import (
    DOMAIN,
    CONF_HOST,
    CONF_PORT,
    CONF_MODEL,
    ATTR_IMAGE_URL,
    ATTR_PROMPT,
    ATTR_IMAGE_NAME,
    SERVICE_ANALYZE_IMAGE,
    EVENT_IMAGE_ANALYZED,
)
from .api import OllamaClient

_LOGGER = logging.getLogger(__name__)

PLATFORMS = [Platform.SENSOR]

# Service schema
ANALYZE_IMAGE_SCHEMA = vol.Schema(
    {
        vol.Required(ATTR_IMAGE_URL): cv.string,
        vol.Required(ATTR_PROMPT): cv.string,
        vol.Required(ATTR_IMAGE_NAME): cv.string,
    }
)

async def async_setup(hass: HomeAssistant, config: ConfigType) -> bool:
    """Set up the Ollama Vision component."""
    hass.data[DOMAIN] = {}
    return True

async def async_setup_entry(hass: HomeAssistant, entry: ConfigEntry) -> bool:
    """Set up Ollama Vision from a config entry."""
    host = entry.data.get(CONF_HOST) or entry.options.get(CONF_HOST)
    port = entry.data.get(CONF_PORT) or entry.options.get(CONF_PORT)
    model = entry.data.get(CONF_MODEL) or entry.options.get(CONF_MODEL)
    
    client = OllamaClient(host, port, model)
    
    # Store the client in hass.data
    hass.data[DOMAIN][entry.entry_id] = {
        "client": client,
        "sensors": {}
    }
    
    # Define the analyze_image service
    async def handle_analyze_image(call: ServiceCall):
        """Handle the analyze_image service call."""
        image_url = call.data.get(ATTR_IMAGE_URL)
        prompt = call.data.get(ATTR_PROMPT)
        image_name = call.data.get(ATTR_IMAGE_NAME)
        
        # Analyze the image
        description = await client.analyze_image(image_url, prompt)
        
        if description is None:
            raise HomeAssistantError("Failed to analyze image")
        
        # Create or update sensor
        sensor_unique_id = f"{DOMAIN}_{image_name}"
        registry = er.async_get(hass)
        
        # Check if sensor already exists
        entity_id = registry.async_get_entity_id(
            Platform.SENSOR, DOMAIN, sensor_unique_id
        )
        
        if not entity_id:
            # Register a new sensor
            entity_id = registry.async_get_or_create(
                Platform.SENSOR,
                DOMAIN,
                sensor_unique_id,
                suggested_object_id=f"ollama_vision_{image_name}",
                config_entry=entry,
            ).entity_id
        
        # Store sensor info
        hass.data[DOMAIN][entry.entry_id]["sensors"][image_name] = {
            "description": description,
            "entity_id": entity_id
        }
        
        # Update sensor state
        hass.states.async_set(entity_id, description, {
            "friendly_name": f"Ollama Vision {image_name}",
            "icon": "mdi:image-search",
            "image_url": image_url,
            "prompt": prompt
        })
        
        # Fire event
        hass.bus.async_fire(
            EVENT_IMAGE_ANALYZED, 
            {
                "image_name": image_name,
                "description": description,
                "image_url": image_url
            }
        )
    
    # Register service
    hass.services.async_register(
        DOMAIN,
        SERVICE_ANALYZE_IMAGE,
        handle_analyze_image,
        schema=ANALYZE_IMAGE_SCHEMA,
    )
    
    # Set up platforms
    await hass.config_entries.async_forward_entry_setups(entry, PLATFORMS)
    
    return True

async def async_unload_entry(hass: HomeAssistant, entry: ConfigEntry) -> bool:
    """Unload a config entry."""
    # Remove all sensors created by this integration
    registry = er.async_get(hass)
    
    # Get sensor entities for this entry
    for sensor_data in hass.data[DOMAIN][entry.entry_id]["sensors"].values():
        entity_id = sensor_data["entity_id"]
        registry.async_remove(entity_id)
    
    # Unload sensor platform
    unload_ok = await hass.config_entries.async_unload_platforms(entry, PLATFORMS)
    
    # Unregister service
    hass.services.async_remove(DOMAIN, SERVICE_ANALYZE_IMAGE)
    
    if unload_ok:
        hass.data[DOMAIN].pop(entry.entry_id)
    
    return unload_ok

async def async_reload_entry(hass: HomeAssistant, entry: ConfigEntry) -> None:
    """Reload config entry."""
    await async_unload_entry(hass, entry)
    await async_setup_entry(hass, entry)